<?php/** * Filter functions for sheet music library fields for theme-compat. * * As of version 2.0, see template-parts.php for building block components for these template filters. *//** * Filter for `the_content()` on non-single piece views (archives, search, etc.). */function sml_archive_content_filter( $the_content ) {	// Get post meta fields' data.	$audio_attachment_id = absint( get_post_meta( get_the_ID(), 'audio-attachment-id', true ) );	$audio_url = ( $audio_attachment_id ) ? wp_get_attachment_url( $audio_attachment_id ) : '';	$video_url = esc_url( get_post_meta( get_the_ID(), 'piece-video-url', true ) );	$no_download_message = get_post_meta( get_the_ID(), 'no-download-message', true );	$button_text = ( $no_download_message ) ? __( 'View Piece &rarr;', 'sheet-music-library' ) : __( 'View & Download &rarr;', 'sheet-music-library' );	ob_start();	?>	<div class="piece archive-piece">		 <div class="piece-meta">			<div class="taxonomy-box">				<p><?php the_terms( get_the_ID(), 'composer', __( 'Composer: ', 'sheet-music-library' ), ', ' ); ?></p>				<p><?php the_terms( get_the_ID(), 'orchestration', __( 'Parts: ', 'sheet-music-library' ), ', ' ); ?></p>				<p><?php the_terms( get_the_ID(), 'difficulty', __( 'Difficulty: ', 'sheet-music-library' ), ', ' ); ?></p>				<p><?php the_terms( get_the_ID(), 'genre', __( 'Genre: ', 'sheet-music-library' ), ', ' ); ?></p>			</div>		</div>		<div class="piece-contents">			<div class="piece-recording">				<?php if ( $audio_url ) {					// Embedded audio player.					echo wp_audio_shortcode( array( 'src' => $audio_url ) );				} elseif ( $video_url ) {					// Skinned embedded YouTube player.					echo wp_video_shortcode( array( 'src' => $video_url ) );				} ?>			</div>			<div class="download-box">				<a class="button" href="<?php the_permalink(); ?>"><?php echo $button_text; ?></a>			</div>		</div>	</div>	<?php	$output = trim( ob_get_contents() );	ob_end_clean();	return $output;}/** * Filter for `the_content()` on single piece views. */function sml_single_content_filter( $the_content ) {	// Get post meta fields' data.	$score_attachment_id = absint( get_post_meta( get_the_ID(), 'score-attachment-id', true ) );	$score_url = ( $score_attachment_id ) ? wp_get_attachment_url( $score_attachment_id ) : '';	$image_url = '';	if ( $score_attachment_id ) {		$image_url = esc_url( get_post_meta( $score_attachment_id, 'pdf_thumbnail_url', true ) );	}	$parts_attachment_id = absint( get_post_meta( get_the_ID(), 'parts-attachment-id', true ) );	$parts_url = ( $parts_attachment_id ) ? wp_get_attachment_url( $parts_attachment_id ) : '';	$audio_attachment_id = absint( get_post_meta( get_the_ID(), 'audio-attachment-id', true ) );	$audio_url = ( $audio_attachment_id ) ? wp_get_attachment_url( $audio_attachment_id ) : '';	$video_url = esc_url( get_post_meta( get_the_ID(), 'piece-video-url', true ) );	$no_download_message = get_post_meta( get_the_ID(), 'no-download-message', true );	$no_download_message = wp_kses( $no_download_message, array(	    'a' => array(	        'href' => array(),	        'title' => array(),			'class' => array(),			'target' => array(),	    ),	    'br' => array(),	    'em' => array(),	    'strong' => array(),		'div' => array(			'class' => array(),			'id' => array(),		)	) );	ob_start();	?>	<div class="piece single-piece">		 <div class="piece-meta wp-caption alignright">			<?php echo sml_sheet_music_download_box( $score_url, $parts_url, $no_download_message ); ?>			<div class="taxonomy-box">				<p><?php the_terms( get_the_ID(), 'composer', __( 'Composer: ', 'sheet-music-library' ), ', ' ); ?></p>				<p><?php the_terms( get_the_ID(), 'orchestration', __( 'Parts: ', 'sheet-music-library' ), ', ' ); ?></p>				<p><?php the_terms( get_the_ID(), 'difficulty', __( 'Difficulty: ', 'sheet-music-library' ), ', ' ); ?></p>				<p><?php the_terms( get_the_ID(), 'genre', __( 'Genre: ', 'sheet-music-library' ), ', ' ); ?></p>			</div>		</div>		<div class="piece-contents">			<?php if ( $image_url && ! $no_download_message ) : ?>				<div class="piece-preview">					<a href="<?php echo $score_url; ?>" target="_blank"><img class="score-preview" src="<?php echo $image_url; ?>" alt="score preview"/></a>				</div>			<?php endif; ?>			<div class="piece-description">				<?php echo $the_content; ?>			</div>			<div class="piece-recording">				<?php if ( $audio_url ) {					// Embedded audio player.					echo wp_audio_shortcode( array( 'src' => $audio_url ) );				}				if ( $video_url ) {					// Skinned embedded YouTube player.					echo wp_video_shortcode( array( 'src' => $video_url ) );				} ?>			</div>			<?php echo sml_sheet_music_download_box( $score_url, $parts_url, $no_download_message ); ?>		</div>	</div>	<?php	$output = trim( ob_get_contents() );	ob_end_clean();	return $output;}// Filter post titles in archive contextsfunction sml_post_title_filter( $title, $post_id ) {	if ( 'sheet_music' === get_post_type( $post_id ) ) {		$no_download_message = get_post_meta( $post_id, 'no-download-message', true );		if ( $no_download_message ) {			if ( ! is_admin() ) {				$title = '<span class="sml-restricted"></span>' . $title;			} else {				$title = '* ' . $title;			}		}	}	return $title;}// All sheet music shortcode.function sml_shortcode_all_sheet_music() {	$pieces = get_posts( array(		'numberposts' => '-1',		'post_type' => 'sheet_music',	) );	return sml_sheet_music_search_form() . sml_table_view_template( $pieces );}// Latest sheet music shortcode.function sml_shortcode_latest_sheet_music( $attrs ) {	$a = shortcode_atts( array(		'number' => 10,	), $attrs );	$pieces = get_posts( array(		'numberposts' => absint( $a['number'] ),		'post_type' => 'sheet_music',	) );	return sml_sheet_music_search_form() . sml_table_view_template( $pieces );}// Sheet music audio playlist shortcode.function sml_shortcode_sheet_music_audio_playlist( $attrs ) {	$a = shortcode_atts( array(		'genre' => '',		'number' => 25,	), $attrs );	if ( $a['genre'] ) {		$args = array(			'tax_query' => array(				array(					'taxonomy' => 'genre',					'field' => 'slug',					'terms' => esc_attr( $a['genre'] ),				)			),			'numberposts' => absint( $a['number'] ),			'post_type' => 'sheet_music',		);	} else {		$args = array(			'numberposts' => absint( $a['number'] ),			'post_type' => 'sheet_music',		);	}	$pieces = get_posts( $args );	$audios = array();	foreach( $pieces as $piece ) {		$audio_attachment_id = absint( get_post_meta( $piece->ID, 'audio-attachment-id', true ) );		if( $audio_attachment_id ) {			$audios[] = $audio_attachment_id;		}	}	return wp_playlist_shortcode( array( 'ids' => implode( ',', $audios ) ) );}// Display a collection of pieces in a table// @param pieces Array of WP_Post objects.function sml_table_view_template( $pieces ) {	if ( ! is_array( $pieces ) ) {		return;	}	ob_start();	?>	<table class="sheet-music-table">		<thead>			<td colspan="2"></td>			<td><?php _e( 'Genre', 'sheet-music-library' ); ?></td>			<td><?php _e( 'Parts', 'sheet-music-library' ); ?></td>			<td><?php _e( 'Difficulty', 'sheet-music-library' ); ?></td>		</thead>		<tbody>		<?php foreach ( $pieces as $piece ) {			sml_single_table_view_template( $piece );		} ?>		</tbody>	</table>	<?php	$output = trim( ob_get_contents() );	ob_end_clean();	return $output;}// Display a single table for a piece.function sml_single_table_view_template( $piece ) {	if ( ! is_object( $piece ) ) {		return;	}	$no_download_message = get_post_meta( $piece->ID, 'no-download-message', true );	$audio_attachment_id = absint( get_post_meta( $piece->ID, 'audio-attachment-id', true ) );	$audio_url = ( $audio_attachment_id ) ? wp_get_attachment_url( $audio_attachment_id ) : '';	?>	<tr>		<th colspan="2"><a href="<?php echo get_permalink( $piece->ID ); ?>" class="sml-table-title<?php if ( $no_download_message ) { echo ' sml-restricted'; } ?>"><?php echo $piece->post_title; ?></a><br>		<small><?php _e( 'By ', 'sheet-music-library' ); the_terms( $piece->ID, 'composer', '', ', ' ); ?></small>		<?php if ( $audio_url ) {			// Embedded audio player			echo wp_audio_shortcode( array( 'src' => $audio_url ) );		} ?>		</td>		<td><?php the_terms( $piece->ID, 'genre', '', ', ' ); ?></td>		<td><?php the_terms( $piece->ID, 'orchestration', '', ', ' ); ?></td>		<td><?php the_terms( $piece->ID, 'difficulty', '', ', ' ); ?></td>	</tr>	<?php}